<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SimLauncher</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    
    <div id="tabs">
        <button onclick="showTab('launcher')">Launcher</button>
        <button onclick="showTab('settings')">Settings</button>
    </div>

    <div id="launcher" class="tab-content active">
        <h1>Launcher</h1>
        
        <div id="game-list"></div>
        <div id="status"></div>

        <div id="profile-editor" class="editor-panel">
            <h2 id="editor-title">Profile Settings: [Game Name]</h2>
            <p>Select which applications to launch with this game:</p>
            <div id="app-checkboxes"></div>
            
            <div class="setting-item">
                <input type="checkbox" id="launch-game-automatically">
                <label for="launch-game-automatically">Launch game automatically after utilities (disable for VR/Monitor choice)</label>
            </div>
            <button onclick="saveProfileSettings()">Save Profile Settings</button>
            <button onclick="hideProfileEditor()">Close</button>
            <div id="profile-status"></div>
        </div>
    </div>

    <div id="settings" class="tab-content">
        <h1>Settings</h1>
        
        <div id="global-settings-form">
            </div>

        <button id="save-settings-btn" onclick="saveSettings()">Save Global Paths</button>
        <div id="settings-status"></div>
    </div>

    <script>
    const { ipcRenderer } = require('electron');

    // --- GLOBAL VARIABLES AND SINGLE SOURCE OF TRUTH ---
    let appPaths = {}; 
    let gamePaths = {};
    
    // UTILITY APPLICATIONS
    const UTILITY_LIST_CONFIG = [
        { key: 'simhub', id: 'simhub-path', name: 'SimHub' },
        { key: 'crewchief', id: 'crewchief-path', name: 'Crew Chief' },
        { key: 'tradingpaints', id: 'tradingpaints-path', name: 'Trading Paints' },
        { key: 'garage61', id: 'garage61-path', name: 'Garage 61' },
        { key: 'secondmonitor', id: 'secondmonitor-path', name: 'Second Monitor' },
        { key: 'customapp1', id: 'customapp1-path', name: 'Custom App 1' },
        { key: 'customapp2', id: 'customapp2-path', name: 'Custom App 2' },
        { key: 'customapp3', id: 'customapp3-path', name: 'Custom App 3' },
        { key: 'customapp4', id: 'customapp4-path', name: 'Custom App 4' },
        { key: 'customapp5', id: 'customapp5-path', name: 'Custom App 5' },
    ];

    // GAMES
    const GAME_LIST_CONFIG = [
        { key: 'ac', id: 'ac-path', name: 'Assetto Corsa' },
        { key: 'acc', id: 'acc-path', name: 'Assetto Corsa Competizione' },
        { key: 'beamng', id: 'beamng-path', name: 'BeamNG' },
        { key: 'eawrc', id: 'eawrc-path', name: 'EA WRC' },
        { key: 'iracing', id: 'iracing-path', name: 'iRacing' },
        { key: 'ams2', id: 'ams2-path', name: 'Automobilista 2' },
        { key: 'rf2', id: 'rf2-path', name: 'rFactor 2' },
        { key: 'lmu', id: 'lmu-path', name: 'Le Mans Ultimate' },
        
    ];

    // --- BASIC UI FUNCTIONS ---

    function showTab(tabId) {
        document.getElementById('profile-editor').style.display = 'none';
        document.getElementById('game-list').style.display = 'flex';
        
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.getElementById(tabId).classList.add('active');
    }

    // --- GENERATION OF FORMS (FIXED) ---
    function generateSettingsForm() {
        const formDiv = document.getElementById('global-settings-form');
        let html = '<h3>Apps</h3>';
        
        // Generate Utility fields
        UTILITY_LIST_CONFIG.forEach(item => {
            html += `<div class="setting-item">
                         <label for="${item.id}">${item.name}:</label>
                         <input type="text" id="${item.id}" placeholder="Path to ${item.name}.exe">
                         <button onclick="browsePath('${item.id}')">Browse</button>
                     </div>`;
        });
        
        html += '<h3>Games</h3>';
        
        // Generate Game fields
        GAME_LIST_CONFIG.forEach(item => {
            html += `<div class="setting-item">
                         <label for="${item.id}">${item.name}:</label>
                         <input type="text" id="${item.id}" placeholder="Path to ${item.name}.exe">
                         <button onclick="browsePath('${item.id}')">Browse</button>
                     </div>`;
        });

        formDiv.innerHTML = html;
    }

    // --- SAVING/LOADING GLOBAL PATHS ---

    function loadSettings() {
        const savedAppPaths = localStorage.getItem('simLauncherAppPaths');
        if (savedAppPaths) appPaths = JSON.parse(savedAppPaths);
        
        const savedGamePaths = localStorage.getItem('simLauncherGamePaths');
        if (savedGamePaths) gamePaths = JSON.parse(savedGamePaths);
        
        // Loop to fill in values
        [...UTILITY_LIST_CONFIG, ...GAME_LIST_CONFIG].forEach(item => {
            const pathValue = appPaths[item.key] || gamePaths[item.key] || '';
            if(document.getElementById(item.id)) { 
                document.getElementById(item.id).value = pathValue;
            }
        });
    }

    function saveSettings() {
        // Saving
        [...UTILITY_LIST_CONFIG, ...GAME_LIST_CONFIG].forEach(item => {
            const value = document.getElementById(item.id).value;
            const key = item.key;
            
            // Determine if it's a utility or a game
            const isUtility = UTILITY_LIST_CONFIG.some(u => u.key === key); 
            
            if (isUtility) {
                appPaths[key] = value;
            } else {
                gamePaths[key] = value;
            }
        });

        localStorage.setItem('simLauncherAppPaths', JSON.stringify(appPaths));
        localStorage.setItem('simLauncherGamePaths', JSON.stringify(gamePaths));

        document.getElementById('settings-status').textContent = 'Global paths saved!';
        document.getElementById('settings-status').style.color = 'lightgreen';
        
        generateGameButtons(); // Refresh the game list with new filtering
    }

    // --- BUTTON GENERATOR ---

    function generateGameButtons() {
        const listDiv = document.getElementById('game-list');
        listDiv.innerHTML = ''; 
        
        GAME_LIST_CONFIG.forEach(game => {
            const key = game.key;
            
            // FILTERING: Show only if a path is set
            if (!gamePaths[key] || gamePaths[key].trim() === "") {
                 return; 
            }

            const container = document.createElement('div');
            container.classList.add('game-profile');
            
            // GAME ICON
            const iconImg = document.createElement('img');
            iconImg.src = `./assets/${key}.png`; 
            iconImg.alt = game.name;
            iconImg.classList.add('game-icon'); 
            container.appendChild(iconImg);

            // 1. Launch button
            const launchBtn = document.createElement('button');
            launchBtn.textContent = `Launch ${game.name}`;
            launchBtn.classList.add('launch-icon');
            launchBtn.onclick = () => launchGameProfile(key);
            
            // 2. Settings button (⚙️)
            const settingsBtn = document.createElement('button');
            settingsBtn.textContent = '⚙️'; 
            settingsBtn.classList.add('settings-icon');
            settingsBtn.onclick = (e) => {
                e.stopPropagation();
                showProfileEditor(key, game.name);
            }

            container.appendChild(launchBtn);
            container.appendChild(settingsBtn);
            listDiv.appendChild(container);
        });
    }

    // --- PROFILE EDITOR (FIXED FILTERING LOGIC) ---

    function showProfileEditor(gameKey, gameName) {
        currentEditingGameKey = gameKey;
        const editor = document.getElementById('profile-editor');
        const checkboxesDiv = document.getElementById('app-checkboxes');
        checkboxesDiv.innerHTML = '';
        
        document.getElementById('editor-title').textContent = `Profile Settings: ${gameName}`;
        
        const savedProfile = JSON.parse(localStorage.getItem(`profile_${gameKey}`)) || {};
        
        // Generating Utility Checkboxes
        UTILITY_LIST_CONFIG.forEach(item => {
            const appKey = item.key;
            
            // CRITICAL FILTER: ONLY DISPLAY UTILITIES WITH A SET PATH
            if (!appPaths[appKey] || appPaths[appKey].trim() === "") {
                return; // Skip utility if path is empty
            }
            
            const div = document.createElement('div');
            div.classList.add('checkbox-item');
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.id = `check_${appKey}`;
            input.name = appKey;
            
            input.checked = savedProfile[appKey] || false; 
            
            const label = document.createElement('label');
            label.htmlFor = `check_${appKey}`;
            label.textContent = item.name;
            
            div.appendChild(input);
            div.appendChild(label);
            checkboxesDiv.appendChild(div);
        });
        
        // Load state for automatic launch
        const autoLaunchCheckbox = document.getElementById('launch-game-automatically');
        autoLaunchCheckbox.checked = (savedProfile.launchAutomatically !== false); 
        
        editor.style.display = 'block';
        document.getElementById('game-list').style.display = 'none';
    }
    
    // --- REMAINDER OF FUNCTIONS ---

    function hideProfileEditor() {
        document.getElementById('profile-editor').style.display = 'none';
        document.getElementById('game-list').style.display = 'flex';
    }
    
    function saveProfileSettings() {
        const profileSettings = {};
        
        UTILITY_LIST_CONFIG.forEach(item => {
            const appKey = item.key;
            const checkbox = document.getElementById(`check_${appKey}`);
            if (checkbox) {
                profileSettings[appKey] = checkbox.checked;
            }
        });
        
        profileSettings.launchAutomatically = document.getElementById('launch-game-automatically').checked;
        
        localStorage.setItem(`profile_${currentEditingGameKey}`, JSON.stringify(profileSettings));
        
        document.getElementById('profile-status').textContent = 'Profile settings saved for ' + currentEditingGameKey.toUpperCase() + '!';
        document.getElementById('profile-status').style.color = 'lightgreen';
        
        setTimeout(hideProfileEditor, 1000); 
    }

    function launchGameProfile(gameKey) {
        const appsToLaunch = [];
        
        const savedProfile = JSON.parse(localStorage.getItem(`profile_${gameKey}`)) || {};
        
        const launchGame = (savedProfile.launchAutomatically !== false); 
        
        // 2. Add utility applications (Filters to include only apps with paths)
        UTILITY_LIST_CONFIG.forEach(item => {
            const appKey = item.key;
            // Check if selected AND path exists
            if (savedProfile[appKey] && appPaths[appKey] && appPaths[appKey].trim() !== "") { 
                appsToLaunch.push(appPaths[appKey]);
            }
        });
        
        // 3. ADD GAME (conditionally, always last)
        if (launchGame) {
            const gamePath = gamePaths[gameKey];
            if (gamePath && gamePath.trim() !== "") {
                appsToLaunch.push(gamePath);
            } else {
                alert(`ERROR: Path to game ${gameKey.toUpperCase()} was not set in global settings!`);
                return;
            }
        }

        // 4. Launch via main.js
        if (appsToLaunch.length > 0) {
            document.getElementById('status').textContent = 'Launching: ' + gameKey.toUpperCase() + ' with ' + appsToLaunch.length + ' applications...';
            ipcRenderer.send('launch-profile', appsToLaunch);
        } else {
            document.getElementById('status').textContent = 'ERROR: No applications were selected for launch!';
            return;
        }

        // 5. MESSAGE FOR MANUAL MODE
        if (!launchGame) {
            document.getElementById('status').textContent += '\nLaunch the game ' + gameKey.toUpperCase() + ' manually (for VR/Monitor choice)!';
        }
    }
    
    function browsePath(inputId) {
        if (!document.getElementById(inputId)) return; 
        ipcRenderer.send('browse-path', inputId); 
    }
    
    ipcRenderer.on('browse-path-result', (event, result) => {
        if (result.filePath) {
            document.getElementById(result.inputId).value = result.filePath;
            saveSettings(); 
        }
    });

    // --- ENTRY POINT ---

    window.onload = () => {
        generateSettingsForm();
        loadSettings(); 
        generateGameButtons(); 
        showTab('launcher'); 
        
        document.getElementById('profile-editor').style.display = 'none'; 
    };
    </script>
</body>
</html>