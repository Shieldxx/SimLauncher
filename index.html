<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sim Racing LaunchPad</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    
    <div id="tabs">
        <button onclick="showTab('launcher')">LAUNCHER</button>
        <button onclick="showTab('settings')">NASTAVENÍ CEST</button>
    </div>

    <div id="launcher" class="tab-content active">
        <h1>Vyberte Hru</h1>
        
        <div id="game-list"></div>
        <div id="status"></div>

        <div id="profile-editor" class="editor-panel">
            <h2 id="editor-title">Nastavení profilu: [Název Hry]</h2>
            <p>Zvolte, které aplikace se spustí s touto hrou:</p>
            <div id="app-checkboxes"></div>
            
            <div class="setting-item">
                <input type="checkbox" id="launch-game-automatically">
                <label for="launch-game-automatically">Spustit hru automaticky po spuštění utilit (vypnout pro volbu VR/Monitor)</label>
            </div>
            <button onclick="saveProfileSettings()">Uložit Nastavení Profilu</button>
            <button onclick="hideProfileEditor()">Zavřít</button>
            <div id="profile-status"></div>
        </div>
    </div>

    <div id="settings" class="tab-content">
        <h2>Globální Cesty k Aplikacím a Hrám</h2>
        
        <div id="global-settings-form">
            </div>

        <button id="save-settings-btn" onclick="saveSettings()">Uložit Globální Cesty</button>
        <div id="settings-status"></div>
    </div>

    <script>
    const { ipcRenderer } = require('electron');

    // --- GLOBÁLNÍ PROMĚNNÉ A JEDEN ZDROJ PRAVDY ---
    let appPaths = {}; 
    let gamePaths = {}; 
    let currentEditingGameKey = null;
    
    // UTILITY APLIKACE
    const UTILITY_LIST_CONFIG = [
        { key: 'simhub', id: 'simhub-path', name: 'SimHub' },
        { key: 'crewchief', id: 'crewchief-path', name: 'Crew Chief' },
        { key: 'racelab', id: 'racelab-path', name: 'Race Lab' },
        { key: 'tradingpaints', id: 'tradingpaints-path', name: 'Trading Paints' },
        { key: 'garage61', id: 'garage61-path', name: 'Garage 61' },
        { key: 'customapp1', id: 'customapp1-path', name: 'Custom App 1' }
    ];

    // HRY
    const GAME_LIST_CONFIG = [
        { key: 'ac', id: 'ac-path', name: 'Assetto Corsa' },
        { key: 'acc', id: 'acc-path', name: 'Assetto Corsa Competizione' },
        { key: 'iracing', id: 'iracing-path', name: 'iRacing' },
        { key: 'ams2', id: 'ams2-path', name: 'Automobilista 2' }
    ];

    // --- ZÁKLADNÍ FUNKCE UI ---

    function showTab(tabId) {
        document.getElementById('profile-editor').style.display = 'none';
        document.getElementById('game-list').style.display = 'flex';
        
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.getElementById(tabId).classList.add('active');
    }

    // --- NOVÁ FUNKCE: Generuje input pole pro Nastavení Cest ---
    function generateSettingsForm() {
        const formDiv = document.getElementById('global-settings-form');
        let html = '<h3>Utility</h3>';
        
        // Generujeme Utility pole
        UTILITY_LIST_CONFIG.forEach(item => {
            html += `<div class="setting-item">
                         <label for="${item.id}">${item.name}:</label>
                         <input type="text" id="${item.id}" placeholder="Cesta k ${item.name}.exe">
                         <button onclick="browsePath('${item.id}')">Procházet</button>
                     </div>`;
        });

        html += '<h3>Hry</h3>';
        
        // Generujeme Herní pole
        GAME_LIST_CONFIG.forEach(item => {
            html += `<div class="setting-item">
                         <label for="${item.id}">${item.name}:</label>
                         <input type="text" id="${item.id}" placeholder="Cesta k ${item.name}.exe">
                         <button onclick="browsePath('${item.id}')">Procházet</button>
                     </div>`;
        });

        formDiv.innerHTML = html;
    }

    // --- ULOŽENÍ/NAČÍTÁNÍ GLOBÁLNÍCH CEST ---

    function loadSettings() {
        const savedAppPaths = localStorage.getItem('simLauncherAppPaths');
        if (savedAppPaths) appPaths = JSON.parse(savedAppPaths);
        
        const savedGamePaths = localStorage.getItem('simLauncherGamePaths');
        if (savedGamePaths) gamePaths = JSON.parse(savedGamePaths);
        
        // Nová smyčka pro doplnění hodnot
        [...UTILITY_LIST_CONFIG, ...GAME_LIST_CONFIG].forEach(item => {
            const pathValue = appPaths[item.key] || gamePaths[item.key] || '';
            if(document.getElementById(item.id)) { 
                document.getElementById(item.id).value = pathValue;
            }
        });
    }

    function saveSettings() {
        // Ukládání
        [...UTILITY_LIST_CONFIG, ...GAME_LIST_CONFIG].forEach(item => {
            const value = document.getElementById(item.id).value;
            const key = item.key;
            
            // Zjišťuje, zda jde o utilitu nebo hru (podle přítomnosti v UTILITY_LIST_CONFIG)
            const isUtility = UTILITY_LIST_CONFIG.some(u => u.key === key); 
            
            if (isUtility) {
                appPaths[key] = value;
            } else {
                gamePaths[key] = value;
            }
        });

        localStorage.setItem('simLauncherAppPaths', JSON.stringify(appPaths));
        localStorage.setItem('simLauncherGamePaths', JSON.stringify(gamePaths));

        document.getElementById('settings-status').textContent = 'Globální cesty uloženy!';
        document.getElementById('settings-status').style.color = 'lightgreen';
        
        generateGameButtons(); // Obnoví seznam her s novým filtrováním
    }

    // --- GENERÁTOR TLAČÍTEK ---

    function generateGameButtons() {
        const listDiv = document.getElementById('game-list');
        listDiv.innerHTML = ''; 
        
        GAME_LIST_CONFIG.forEach(game => {
            const key = game.key;
            
            // FILTRACE: Zobrazit, jen když má cestu
            if (!gamePaths[key] || gamePaths[key].trim() === "") {
                 return; 
            }

            const container = document.createElement('div');
            container.classList.add('game-profile');
            
            // IKONKA HRY
            const iconImg = document.createElement('img');
            iconImg.src = `./assets/${key}.png`; 
            iconImg.alt = game.name;
            iconImg.classList.add('game-icon'); 
            container.appendChild(iconImg);

            // 1. Tlačítko pro spuštění hry
            const launchBtn = document.createElement('button');
            launchBtn.textContent = game.name;
            launchBtn.onclick = () => launchGameProfile(key);
            
            // 2. Tlačítko pro nastavení (⚙️)
            const settingsBtn = document.createElement('button');
            settingsBtn.textContent = '⚙️'; 
            settingsBtn.classList.add('settings-icon');
            settingsBtn.onclick = (e) => {
                e.stopPropagation();
                showProfileEditor(key, game.name); // Používáme game.name
            }

            container.appendChild(launchBtn);
            container.appendChild(settingsBtn);
            listDiv.appendChild(container);
        });
    }
    
    // --- EDITOR PROFILU ---

    function showProfileEditor(gameKey, gameName) {
        currentEditingGameKey = gameKey;
        const editor = document.getElementById('profile-editor');
        const checkboxesDiv = document.getElementById('app-checkboxes');
        checkboxesDiv.innerHTML = '';
        
        document.getElementById('editor-title').textContent = `Nastavení profilu: ${gameName}`;
        
        const savedProfile = JSON.parse(localStorage.getItem(`profile_${gameKey}`)) || {};
        
        // Generování Checkboxů utilit
        UTILITY_LIST_CONFIG.forEach(item => { // Používáme novou strukturu
            const appKey = item.key;
            const div = document.createElement('div');
            div.classList.add('checkbox-item');
            const input = document.createElement('input');
            input.type = 'checkbox';
            input.id = `check_${appKey}`;
            input.name = appKey;
            
            input.checked = savedProfile[appKey] || false; 
            
            const label = document.createElement('label');
            label.htmlFor = `check_${appKey}`;
            label.textContent = item.name; // Používáme čisté jméno (např. SimHub)
            
            div.appendChild(input);
            div.appendChild(label);
            checkboxesDiv.appendChild(div);
        });
        
        // Načtení stavu pro automatické spuštění
        const autoLaunchCheckbox = document.getElementById('launch-game-automatically');
        autoLaunchCheckbox.checked = (savedProfile.launchAutomatically !== false); 
        
        editor.style.display = 'block';
        document.getElementById('game-list').style.display = 'none';
    }

    function hideProfileEditor() {
        document.getElementById('profile-editor').style.display = 'none';
        document.getElementById('game-list').style.display = 'flex';
    }
    
    function saveProfileSettings() {
        const profileSettings = {};
        
        UTILITY_LIST_CONFIG.forEach(item => { // Nová smyčka pro ukládání checkboxů
            const appKey = item.key;
            const checkbox = document.getElementById(`check_${appKey}`);
            if (checkbox) {
                profileSettings[appKey] = checkbox.checked;
            }
        });
        
        profileSettings.launchAutomatically = document.getElementById('launch-game-automatically').checked;
        
        localStorage.setItem(`profile_${currentEditingGameKey}`, JSON.stringify(profileSettings));
        
        document.getElementById('profile-status').textContent = `Nastavení profilu uloženo pro ${currentEditingGameKey.toUpperCase()}!`;
        document.getElementById('profile-status').style.color = 'lightgreen';
        
        setTimeout(hideProfileEditor, 1000); 
    }

    // --- SPOUŠTĚNÍ HRY A UTILIT (LAUNCH) ---

    function launchGameProfile(gameKey) {
        const appsToLaunch = [];
        
        const savedProfile = JSON.parse(localStorage.getItem(`profile_${gameKey}`)) || {};
        
        const launchGame = (savedProfile.launchAutomatically !== false); 
        
        // 2. Přidání utility aplikací
        UTILITY_LIST_CONFIG.forEach(item => { // Nová smyčka
            const appKey = item.key;
            if (savedProfile[appKey] && appPaths[appKey] && appPaths[appKey].trim() !== "") { 
                appsToLaunch.push(appPaths[appKey]);
            }
        });
        
        // 3. PŘIDÁNÍ HRY (podmíněně)
        if (launchGame) {
            const gamePath = gamePaths[gameKey];
            if (gamePath && gamePath.trim() !== "") {
                appsToLaunch.push(gamePath);
            } else {
                alert(`CHYBA: Cesta k hře ${gameKey.toUpperCase()} nebyla v globálním nastavení zadána!`);
                return;
            }
        }

        // 4. Spuštění přes main.js
        if (appsToLaunch.length > 0) {
            document.getElementById('status').textContent = `Spouštím: ${gameKey.toUpperCase()} s ${appsToLaunch.length} aplikacemi...`;
            ipcRenderer.send('launch-profile', appsToLaunch);
        } else {
            document.getElementById('status').textContent = `CHYBA: Nebyly vybrány žádné aplikace ke spuštění!`;
            return;
        }

        // 5. ZPRÁVA PRO MANUÁLNÍ REŽIM
        if (!launchGame) {
            document.getElementById('status').textContent += `\nSpusťte hru ${gameKey.toUpperCase()} manuálně (pro volbu VR/Monitor)!`;
        }
    }
    
    // --- IPC PRO BROWSE PATH ---
    function browsePath(inputId) {
        if (!document.getElementById(inputId)) return; 
        ipcRenderer.send('browse-path', inputId); 
    }
    
    ipcRenderer.on('browse-path-result', (event, result) => {
        if (result.filePath) {
            document.getElementById(result.inputId).value = result.filePath;
            saveSettings(); 
        }
    });

    // --- VSTUPNÍ BOD ---

    window.onload = () => {
        generateSettingsForm(); // Spustíme generování formulářů
        loadSettings(); 
        generateGameButtons(); 
        showTab('launcher'); 
        
        document.getElementById('profile-editor').style.display = 'none'; 
    };
    </script>
</body>
</html>